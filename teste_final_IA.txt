/*
 * CÓDIGO FINAL - DESAFIO EXTRA (Firebase + Pinos do Amigo)
 * Hardware: ESP32, Sensor HC-SR04, Buzzer
 * Ação: Loga dados no Firebase com resposta gradativa do buzzer
 *
 * PINAGEM ATUALIZADA (do seu amigo):
 * - Sensor Trig: D2
 * - Sensor Echo: D4
 * - Buzzer (+):  D26
 */

// Bibliotecas necessárias
#include <WiFi.h>
#include <FirebaseESP32.h>

// --- 1. CONFIGURAÇÃO (PREENCHA SÓ O WI-FI) ---
#define WIFI_SSID "NOME_DA_SUA_REDE_WIFI" // <-- PREENCHA AQUI
#define WIFI_PASSWORD "SUA_SENHA_WIFI"  // <-- PREENCHA AQUI

// Credenciais do Firebase (JÁ PREENCHIDAS)
#define FIREBASE_HOST "detector-distanciaesp32-default-rtdb.firebaseio.com" 
#define FIREBASE_AUTH "dBfZaKDrBPmDqttQBPhrh3ZQhLjlEENVMn5HJrNP" 

// Pinos dos componentes (ATUALIZADOS)
const int trigPin = 2;
const int echoPin = 4;
const int buzzerPin = 26;

// Variáveis para o cálculo
long duration;
float distance; // Usar float para mais precisão

// Objetos do Firebase
FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;

// Variável para armazenar a ação disparada (conforme PDF)
String acaoDisparada = "INICIALIZANDO";
unsigned long idEpisodio = 0; // Contador para o ID

void setup() {
  Serial.begin(115200);
  
  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);
  pinMode(buzzerPin, OUTPUT);
  digitalWrite(buzzerPin, LOW); // Garante que comece desligado

  // --- 2. CONECTAR AO WI-FI ---
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  Serial.print("Conectando ao Wi-Fi");
  while (WiFi.status() != WL_CONNECTED) {
    Serial.print(".");
    delay(300);
  }
  Serial.println("\nConectado!");

  // --- 3. CONECTAR AO FIREBASE ---
  config.host = FIREBASE_HOST;
  config.api_key = FIREBASE_AUTH;
  
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);
}

void loop() {
  // 1. Faz a leitura da distância
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);
  
  duration = pulseIn(echoPin, HIGH);
  distance = duration * 0.0343 / 2; // Percepção D(t)

  Serial.print("Distancia: ");
  Serial.print(distance);
  Serial.println(" cm");

  // --- 4. LÓGICA R.C.A. (FOCO NO BUZZER GRADATIVO) ---
  // Baseado na tabela "Regras Condição-Ação" do PDF
  
  if (distance > 50) {
    // Zona Segura
    acaoDisparada = "BUZZER_OFF_SEGURO";
    digitalWrite(buzzerPin, LOW); // Buzzer Desligado
    
  } else if (distance > 20 && distance <= 50) {
    // Zona de Atenção
    acaoDisparada = "BUZZER_OFF_ATENCAO";
    digitalWrite(buzzerPin, LOW); // Buzzer Desligado
    
  } else if (distance > 10 && distance <= 20) {
    // Zona de Alerta
    acaoDisparada = "BUZZER_PULSANTE_LENTO";
    digitalWrite(buzzerPin, HIGH); // Buzzer Pulsando
    delay(80); // Duração do pulso
    digitalWrite(buzzerPin, LOW);
    
  } else if (distance <= 10 && distance > 0) {
    // Zona Crítica
    acaoDisparada = "BUZZER_MAXIMO_CONTINUO";
    digitalWrite(buzzerPin, HIGH); // Buzzer Contínuo
    
  } else {
    // Fora de alcance ou erro
    acaoDisparada = "ERRO_LEITURA";
