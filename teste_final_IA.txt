#include <WiFi.h>
#include <WebServer.h>

// --- Configure sua Rede ---
const char* ssid = "TRIO";
const char* password = "10204080PF";
// --------------------------

// Pinos do Hardware (baseado no seu circuito)
const int TRIG_PIN = 5;
const int ECHO_PIN = 18;
const int BUZZER_PIN = 23;
const int LED_PIN = 21; // Pino D21 (o LED que você montou)

// Cria o servidor na porta 80 (padrão web)
WebServer server(80);

// Variável global para guardar a distância
float distanciaCm = 0;

void setup() {
  Serial.begin(115200); // Inicia o monitor serial (para ver o IP)
  
  // Define os modos dos pinos
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  pinMode(LED_PIN, OUTPUT);
  pinMode(BUZZER_PIN, OUTPUT);

  // --- Conectando ao Wi-Fi ---
  Serial.print("Conectando a ");
  Serial.println(ssid);
  WiFi.begin(ssid, password);

  // Espera a conexão
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  // Se conectou, imprime o IP
  Serial.println("\nWiFi conectado!");
  Serial.print("Servidor iniciado no IP: ");
  Serial.println(WiFi.localIP());

  // --- Configurando o Servidor Web ---
  // Define o que acontece quando alguém acessa a página principal ("/")
  server.on("/", handleRoot);
  
  // Inicia o servidor
  server.begin();
}

void loop() {
  // 1. Atualiza a leitura da distância
  lerDistancia();
  
  // 2. Controla o alarme local (LED e Buzzer)
  controlarAlarme();
  
  // 3. Permite que o servidor web atenda clientes (seu celular)
  server.handleClient();
}

// Função que lê o sensor
void lerDistancia() {
  // Dispara o pulso do Trigger
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);
  
  // Lê o tempo de retorno do Echo
  long duration = pulseIn(ECHO_PIN, HIGH);
  
  // Calcula a distância
  // 34300 cm/s (velocidade do som) / 2 (ida e volta)
  distanciaCm = duration * 0.034 / 2;
}

// Função que controla o alarme
void controlarAlarme() {
  // Se o objeto estiver a menos de 20cm (e não for 0)
  if (distanciaCm > 0 && distanciaCm < 20) {
    digitalWrite(LED_PIN, HIGH); // Acende o LED
    tone(BUZZER_PIN, 1500, 100); // Toca um bipe (1500 Hz por 100ms)
  } else {
    digitalWrite(LED_PIN, LOW); // Apaga o LED
    noTone(BUZZER_PIN); // Desliga o buzzer
  }
}

// Função que "constrói" a página da web
void handleRoot() {
  String html = "<html><head>";
  html += "<title>ESP32 - Sensor de Distancia</title>";
  // Esta linha faz a página recarregar sozinha a cada 2 segundos
  html += "<meta http-equiv='refresh' content='2'>";
  html += "<style>";
  html += "body { font-family: Arial, sans-serif; text-align: center; background-color: #282c34; color: white; }";
  html += "h1 { color: #61dafb; }";
  html += "p { font-size: 5rem; font-weight: bold; margin-top: 50px; }";
  html += ".unidade { font-size: 2rem; }";
  html += "</style>";
  html += "</head><body>";
  html += "<h1>Projeto Sensor de Proximidade</h1>";
  html += "<p>";
  html += String(distanciaCm, 1); // Mostra a distância com 1 casa decimal
  html += "<span class='unidade'> cm</span></p>";
  html += "</body></html>";
  
  // Envia a página pronta para o navegador
  server.send(200, "text/html", html);
}